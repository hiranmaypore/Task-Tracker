
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum ProjectRole {
  OWNER
  EDITOR
  VIEWER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model User {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  email         String          @unique
  password_hash String
  role          UserRole        @default(USER)
  created_at    DateTime        @default(now())
  updated_at    DateTime        @updatedAt

  owned_projects Project[]       @relation("ProjectOwner")
  memberships    ProjectMember[]
  assigned_tasks Task[]          @relation("TaskAssignee")
  comments       Comment[]
  activity_logs  ActivityLog[]
  events         Event[]
  automation_rules AutomationRule[]
  notifications    Notification[]
  
  // Google Calendar Sync
  googleAccessToken   String?
  googleRefreshToken  String?
  googleTokenExpiry   DateTime?
  calendarSyncEnabled Boolean   @default(false)
  avatar              String?
}

model Project {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  owner_id   String   @db.ObjectId
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  owner   User            @relation("ProjectOwner", fields: [owner_id], references: [id])
  members ProjectMember[]
  tasks   Task[]
}

model ProjectMember {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  project_id String      @db.ObjectId
  user_id    String      @db.ObjectId
  role       ProjectRole @default(VIEWER)
  joined_at  DateTime    @default(now())

  project Project @relation(fields: [project_id], references: [id])
  user    User    @relation(fields: [user_id], references: [id])

  @@unique([project_id, user_id])
}

model Task {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  title          String
  description    String?
  status         TaskStatus   @default(TODO)
  priority       TaskPriority @default(MEDIUM)
  due_date       DateTime?
  project_id     String       @db.ObjectId
  assignee_id    String?      @db.ObjectId
  parent_task_id String?      @db.ObjectId
  created_at     DateTime     @default(now())
  updated_at     DateTime     @updatedAt
  completed_at   DateTime?

  project     Project   @relation(fields: [project_id], references: [id])
  assignee    User?     @relation("TaskAssignee", fields: [assignee_id], references: [id])
  parent_task Task?     @relation("SubTasks", fields: [parent_task_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subtasks    Task[]    @relation("SubTasks")
  comments    Comment[]
}

model Comment {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  task_id    String   @db.ObjectId
  user_id    String   @db.ObjectId
  content    String
  created_at DateTime @default(now())

  task Task @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [id])
}

model ActivityLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  user_id     String   @db.ObjectId
  action      String
  entity_type String
  entity_id   String
  timestamp   DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}

model Event {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  type      String
  metadata  Json?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt(sort: Desc)])
  @@index([type])
}

model AutomationRule {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  ownerId    String   @db.ObjectId
  trigger    String
  conditions Json
  actions    String[]
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  owner      User     @relation(fields: [ownerId], references: [id])
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  title     String
  message   String
  type      String   @default("INFO") // INFO, SUCCESS, WARNING, ERROR
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}
